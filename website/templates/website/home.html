<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GSM Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<div class="container my-5">
  {% if user.is_authenticated %}
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Welcome, {{ user.username }} üëã</h2>
      <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button class="btn btn-outline-danger" type="submit">Logout</button>
      </form>
    </div>

    <div class="row">
      <!-- Available Stocks -->
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between">
            üìà <strong>Available Stocks</strong>
            <button class="btn btn-sm btn-outline-primary" onclick="fetchData()">üîÑ Refresh</button>
          </div>
          <div class="card-body" id="stocks">
            <p>Loading...</p>
          </div>
        </div>
      </div>

      <!-- Portfolio -->
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
          <div class="card-header">üíº <strong>Your Portfolio</strong></div>
          <div class="card-body" id="portfolio">
            <p>No holdings yet.</p>
          </div>
        </div>
      </div>

      <!-- Transactions -->
      <div class="col-md-12 mb-4">
        <div class="card shadow-sm">
          <div class="card-header">üßæ <strong>Recent Transactions</strong></div>
          <div class="card-body p-0">
            <table class="table table-sm table-striped mb-0">
              <thead>
                <tr>
                  <th>Action</th>
                  <th>Symbol</th>
                  <th>Qty</th>
                  <th>Price</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody id="transactions">
                <tr><td colspan="5" class="text-center">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Trade Form -->
      <div class="col-md-12 mb-4">
        <div class="card shadow-sm">
          <div class="card-header">üí∏ <strong>Buy/Sell Stock</strong></div>
          <div class="card-body">
            <form id="trade-form">
              {% csrf_token %}
              <div class="row g-2 align-items-end">
                <div class="col-md-4">
                  <label class="form-label">Stock Ticker</label>
                  <input type="text" name="symbol" class="form-control" required>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Quantity</label>
                  <input type="number" name="quantity" class="form-control" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Action</label>
                  <select name="transaction_type" class="form-select">
                    <option value="BUY">BUY</option>
                    <option value="SELL">SELL</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <button class="btn btn-success w-100" type="submit">Execute Trade</button>
                </div>
              </div>
            </form>
            <p id="message" class="mt-3 fw-semibold"></p>
          </div>
        </div>
      </div>
    </div>

  {% else %}
    <div class="text-center">
      <h2>Welcome to GSM</h2>
      <p>
        <a href="{% url 'login' %}" class="btn btn-primary me-2">Login</a>
        <a href="{% url 'signup' %}" class="btn btn-outline-primary">Signup</a>
      </p>
    </div>
  {% endif %}
</div>

<script>
  const csrftoken = '{{ csrf_token }}';
  let stockList = [];

  async function fetchData() {
    const [stocksRes, portfolioRes, transactionsRes] = await Promise.all([
      fetch('/api/stocks/', { credentials: 'include' }),
      fetch('/api/portfolio/', { credentials: 'include' }),
      fetch('/api/transactions/', { credentials: 'include' })
    ]);

    const stocks = await stocksRes.json();
    const portfolio = await portfolioRes.json();
    const transactions = await transactionsRes.json();
    stockList = stocks;

    // Update Available Stocks + Charts
    document.getElementById('stocks').innerHTML = stocks.map(s => `
      <div class="mb-4">
        <div class="d-flex justify-content-between border-bottom py-1">
          <strong>${s.symbol}</strong>
          <span>${s.name}</span>
          <span>‚Çπ${s.price}</span>
        </div>
        <canvas id="chart-${s.symbol}" height="100"></canvas>
      </div>
    `).join('');

    // Enhanced Price Charts
    stocks.forEach(s => {
      fetch(`/api/history/${s.symbol}/`, { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          const prices = data.map(d => d.price);
          const timestamps = data.map(d => new Date(d.timestamp).toLocaleTimeString());
          const min = Math.min(...prices);
          const max = Math.max(...prices);
          const padding = (max - min) * 0.1 || 1;

          const ctx = document.getElementById(`chart-${s.symbol}`).getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: timestamps,
              datasets: [{
                label: `${s.symbol} Price`,
                data: prices,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 1,
                borderWidth: 2,
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: ctx => `‚Çπ${ctx.formattedValue}`
                  }
                }
              },
              scales: {
                x: {
                  ticks: { maxTicksLimit: 6 }
                },
                y: {
                  beginAtZero: false,
                  suggestedMin: min - padding,
                  suggestedMax: max + padding,
                  ticks: {
                    callback: value => `‚Çπ${value}`
                  }
                }
              }
            }
          });
        });
    });

    // Portfolio
    document.getElementById('portfolio').innerHTML = portfolio.length > 0 ?
      portfolio.map(p => `
        <div class="d-flex justify-content-between border-bottom py-1">
          <strong>${p.stock.symbol}</strong>
          <span>${p.quantity} shares</span>
        </div>
      `).join('') : `<p>No holdings yet.</p>`;

    // Transactions
    document.getElementById('transactions').innerHTML = transactions.length > 0 ?
      transactions.map(t => `
        <tr>
          <td>${t.transaction_type}</td>
          <td>${t.stock.symbol}</td>
          <td>${t.quantity}</td>
          <td>‚Çπ${t.price_at_execution}</td>
          <td>${new Date(t.timestamp).toLocaleString()}</td>
        </tr>
      `).join('') : `<tr><td colspan="5" class="text-center">No recent trades</td></tr>`;
  }

  document.getElementById('trade-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = e.target;
    const symbol = form.symbol.value.toUpperCase();
    const selectedStock = stockList.find(s => s.symbol === symbol);
    const msgEl = document.getElementById('message');

    if (!selectedStock) {
      msgEl.innerText = "‚ùå Error: Stock not found!";
      msgEl.style.color = "red";
      return;
    }

    const data = {
      stock_id: selectedStock.id,
      quantity: form.quantity.value,
      transaction_type: form.transaction_type.value
    };

    const res = await fetch('/api/transactions/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      credentials: 'include',
      body: JSON.stringify(data)
    });

    if (res.ok) {
      msgEl.innerText = "‚úÖ Trade executed successfully!";
      msgEl.style.color = "green";
      form.reset();
      fetchData();
    } else {
      const error = await res.json();
      msgEl.innerText = "‚ùå Error: " + JSON.stringify(error);
      msgEl.style.color = "red";
    }
  });

  fetchData();
  setInterval(fetchData, 30000); // Refresh every 30s
</script>

</body>
</html>
